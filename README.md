# MP Publisher - 微信公众号发布插件

一个功能强大的 Obsidian 插件，支持自定义样式预览和一键发布到微信公众号。

https://github.com/user-attachments/assets/b62e82a0-9b3c-4406-8007-1bbb6b9b7bac

## ✨ 功能特点

### 📐 样式自定义
- **12+ 预设主题模板**：提供多种精美的公众号样式主题
- **自定义模板**：支持创建和管理自己的样式模板
- **字体选择**：多种中文字体可选
- **字号调整**：灵活调整文章字号
- **背景管理**：支持添加自定义背景图

### 👁️ 实时预览
- **所见即所得**：实时预览公众号效果
- **样式切换**：即时切换不同主题查看效果
- **锁定预览**：可锁定预览状态，专注编辑

### 🚀 一键发布
- **直接发布**：通过微信公众号 API 直接发布草稿
- **图片上传**：自动上传文档中的图片到微信服务器
- **草稿同步**：支持更新已发布的草稿
- **封面选择**：从微信素材库选择或上传封面图
- **元数据管理**：自动管理发布状态和图片信息

### 📋 便捷复制
- **一键复制**：复制格式化后的内容到剪贴板
- **格式保持**：完美保持样式，可直接粘贴到公众号编辑器

## 📦 安装

### 从 Obsidian 社区插件安装（推荐）
1. 打开 Obsidian 设置
2. 进入"第三方插件"
3. 关闭"安全模式"
4. 点击"浏览"并搜索"MP Publisher"
5. 点击安装并启用

### 手动安装
1. 下载最新版本的 release `mp-publisher.zip` 文件
2. 将文件解压到 `<vault>/.obsidian/plugins/` 目录
3. 重新加载 Obsidian
4. 在设置中启用插件

## 🚀 快速开始

### 第一步：配置微信公众号 API

1. **获取 API 凭证**
   - 登录 [微信公众平台](https://mp.weixin.qq.com/)
   - 进入"设置与开发" > "基本配置"
   - 记录你的 `AppID` 和 `AppSecret`
   - 在 `APP IP 白名单`中输入你的本地 ip 地址，不知道的可以问问 AI

2. **在插件中配置**
   - 打开 Obsidian 设置
   - 找到 "MP Publisher" 设置
   - 在"微信公众号配置"部分填入：
     - AppID
     - AppSecret
   - 可选：配置图片存储位置（默认：`[文档名]__assets`）

### 第二步：开始使用

#### 预览功能
1. **打开预览窗口**
   - 点击左侧栏的发送图标 📤
   - 或按 Ctrl+P 打开命令面板，输入"打开公众号发布插件"

2. **选择样式**
   - 在预览窗口顶部选择主题模板
   - 调整字体和字号
   - 实时查看效果

3. **复制到公众号**
   - 点击"复制到公众号"按钮
   - 打开微信公众号编辑器
   - 粘贴（Ctrl+V 或 Cmd+V）

#### 发布功能
1. **准备发布**
   - 确保已配置微信公众号 API
   - 编辑好你的文章内容

2. **发布文章**
   - 点击预览窗口的"发布"按钮
   - 或使用命令"发布到微信公众号"
   - 输入标题
   - 选择或上传封面图
   - 点击"发布"

3. **查看结果**
   - 登录微信公众平台
   - 进入"内容与互动" > "草稿箱"
   - 找到刚发布的草稿

## 📋 常用功能速查

### 键盘快捷键
- `Ctrl+P` (或 `Cmd+P`) - 打开命令面板
- 搜索 "mp" 可快速找到插件命令

### 预览窗口控件
- 🔓 **锁定按钮** - 开启/关闭实时预览
- **模板选择器** - 切换不同主题
- **字体选择器** - 更换字体
- **± 按钮** - 调整字号
- **复制按钮** - 复制格式化内容
- **发布按钮** - 一键发布到微信

## ⚙️ 配置说明

### 微信公众号配置
- **AppID**：公众号的应用ID
- **AppSecret**：公众号的应用密钥
- 获取方式：登录微信公众平台 > 设置与开发 > 基本配置

### 图片存储配置
- **存储位置模式**：
  - `[文档名]__assets`：在文档同级创建资产文件夹
  - `.obsidian/assets`：统一存储在 Obsidian 配置目录
  - 自定义路径：指定任意路径

### 调试模式
- 开启后会在控制台输出详细日志
- 便于排查问题

## 🎨 支持的 Markdown 语法

- ✅ 标题（H1-H6）
- ✅ 段落和换行
- ✅ 粗体、斜体、删除线
- ✅ 有序列表和无序列表
- ✅ 任务列表
- ✅ 引用块
- ✅ 代码块（支持语法高亮）
- ✅ 行内代码
- ✅ 链接
- ✅ 图片
- ✅ 表格
- ✅ 分隔线
- ✅ 脚注

## 📝 元数据管理

插件会在文档的 `[文档名]__assets` 文件夹中创建 `metadata.json` 文件，用于存储：
- 发布的草稿信息（media_id、item）
- 已上传图片的映射关系
- 最后发布时间

## 💡 使用技巧

### 1. 图片管理
- 图片会自动存储在 `[文档名]__assets` 文件夹
- 发布时会自动上传到微信服务器
- 已上传的图片会缓存，避免重复上传

### 2. 样式自定义
- 可以基于现有模板创建新模板
- 支持完全自定义 CSS 样式
- 使用"预览"功能查看效果后再保存

### 3. 草稿更新
- 再次发布同一文档会自动更新草稿
- 元数据保存在 `[文档名]__assets/metadata.json`
- 删除该文件可以创建新草稿

### 4. 批量发布
- 可以为多个文档分别配置不同的样式
- 使用命令面板快速切换文档并发布

## 🔧 常见问题与解决

### Q: 发布时提示"请先配置微信公众号"？
**A:** 需要在插件设置中填入有效的 AppID 和 AppSecret。

### Q: 发布时提示"无法获取 Access Token"？
**A:** 请检查以下几点：
1. AppID 和 AppSecret 是否正确（注意区分大小写）
2. 当前 IP 是否已添加到微信公众平台白名单
3. 网络连接是否正常
4. 公众号是否已被封禁或限制

### Q: 发布时提示"AppID 为空"（错误码 41002）？
**A:** 这个错误表示没有正确填写 AppID。解决方法：
1. 打开 Obsidian 设置 > 第三方插件 > MP Publisher
2. 确认"微信公众号配置"中的 **AppID** 已填写
3. 填写完成后关闭设置窗口，重新尝试发布

⚠️ **注意事项**：
- 确保 AppID 没有多余的空格
- 修改设置后需要重新打开预览窗口或重启 Obsidian
- AppID 通常是 18 位左右的字符串，如 `wx1234567890abcdef`

### Q: 发布时提示"IP 白名单错误"（错误码 40164）？
**A:** 这是由于微信公众平台的 IP 白名单安全机制导致的。解决方法：
1. 登录 [微信公众平台](https://mp.weixin.qq.com/)
2. 进入「设置与开发」→「基本配置」→「IP 白名单」
3. 点击「修改」并添加提示中的 IP 地址
4. 使用管理员微信扫码确认保存

⚠️ **注意事项**：
- 如果你的网络使用动态 IP，每次 IP 变化后都需要更新白名单
- 修改白名单后可能需要等待 5-10 分钟才能生效
- 你可以通过访问 [whatismyip.com](https://www.whatismyip.com/) 查看当前公网 IP

### Q: 图片上传失败？
**A:** 请检查以下几点：
1. 图片格式是否为 JPG 或 PNG
2. 图片大小是否超过 2MB
3. 微信公众号 API 配置是否正确
4. 图片路径是否正确（相对路径或绝对路径）
5. 网络连接是否稳定

### Q: 样式在公众号编辑器中显示不正确？
**A:** 
1. 使用"复制到公众号"功能而不是直接复制粘贴
2. 某些复杂样式可能被微信编辑器过滤，尝试简化样式
3. 确保在预览窗口选择的样式正确
4. 尝试清除浏览器缓存后重新打开公众号编辑器

### Q: 如何获取微信公众号的 AppID 和 AppSecret？
**A:** 登录微信公众平台 > 设置与开发 > 基本配置，可以查看和获取。

### Q: 发布后在哪里查看？
**A:** 登录微信公众平台 > 内容与互动 > 草稿箱，可以看到发布的草稿。

### Q: 插件无法加载？
**A:** 
1. 确保 `main.js`、`manifest.json`、`styles.css` 都在插件目录
2. 检查 Obsidian 版本是否 >= 0.15.0
3. 查看开发者工具的控制台错误信息（按 F12 打开）

### Q: 如何创建自定义模板？
**A:** 
1. 打开设置 > MP Publisher > 模板管理
2. 点击"+ 新建模板"
3. 配置各种元素的样式（标题、段落、列表、代码等）
4. 点击"预览"查看效果
5. 保存模板

### Q: 如何添加自定义字体？
**A:** 
1. 打开设置 > MP Publisher > 字体管理
2. 点击"+ 新建字体"
3. 输入字体名称和 CSS font-family 值
4. 保存后即可在预览窗口选择

### Q: 如何添加自定义背景？
**A:** 
1. 打开设置 > MP Publisher > 背景管理
2. 点击"+ 新建背景"
3. 上传图片或输入图片 URL
4. 在预览窗口选择背景

## 🎓 最佳实践

### 1. 内容编写
- 使用标准 Markdown 语法
- 合理使用标题层级
- 图片使用描述性文件名
- 保持段落简洁

### 2. 样式选择
- 根据内容类型选择合适的模板
- 技术文章推荐"Dark"或"Minimal"主题
- 文学内容推荐"Elegant"主题

### 3. 发布流程
- 先在预览窗口检查样式
- 确认无误后再发布
- 发布后在微信平台进行最后检查

### 4. 图片优化
- 发布前压缩图片以减小大小
- 使用适当的图片尺寸
- 避免使用过多图片

## 🤝 贡献

欢迎提交 Issue 和 Pull Request！

## 📄 许可证

MIT License

## 🙏 致谢

本插件整合了以下优秀项目的功能：
- [mp-preview](https://github.com/Yeban8090/mp-preview): 样式模板预览系统
- [obsidian-enhanced-publisher](https://github.com/chararch/obsidian-enhanced-publisher): 微信发布功能

---

**如果这个插件对你有帮助，欢迎 Star ⭐️**
